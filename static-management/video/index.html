<!DOCTYPE html>
<link rel=stylesheet href=/style.css>
<ul id="soundCues"></ul>
<template id=soundCueTemplate>
  <li>
    <h1 class=title>title</h1>
    <!--<div class=time>00:00:00</div>-->
    <div class=buttons>
      <button class=startButton>Start</button>
      <button class=stopButton disabled>Stop</button>
    </div>
    <input type=range value=1 min=0 max=1.5 step=0.01 class=volume list=volumeDetents></input>
  </li>
</template>
<datalist id=volumeDetents>
  <option value=1>
</datalist>
<script>

const soundPlaybackState = {};
let conn;

const connectWs = () => {
  const ws = new WebSocket(`${location.protocol == 'https:' ? 'wss' : 'ws'}://${location.host}/ws`);

  ws.onclose = e => {
    setTimeout(connectWs, 1000);
  };
  ws.onmessage = e => {
    const message = JSON.parse(e.data);
    const {type, body} = message;
    switch (type) {
      default:
        console.log('message', type, body);
    }
  };
  ws.onopen = e => {
    conn.sendSound();
  };

  conn = {
    send(type, body) {
      ws.send(JSON.stringify({ type, body }));
    },
    sendSound() {
      this.send('setKnob', {name : "hmlt_sound", value : soundPlaybackState });
    },
  };
};

connectWs();

class VideoController{
  constructor(folder, video_name) {
    this.el = soundCueTemplate.content.firstElementChild.cloneNode(true);

    this.startButton = this.el.querySelector('.startButton');

    this.el.querySelector('.title').textContent =video_name;

    let uri = `${folder}/${video_name}`

    this.startButton.addEventListener('mousedown', e => {
      e.preventDefault();
      conn && conn.send('broadcast', {type: 'hmlt_chat', body:{cmd : 'play_video', data : uri}})

      // this.setNeedsDisplay();
    });

    
  }
 
}
let config = 'video_config.js'
 fetch(`https://hamlet-gl-assets.s3.amazonaws.com/config/${config}`)
 .then(
        response => response.json())
        .then(data => {
          let {folder} = data
           data.videos.map(video_name => {return new VideoController(folder,video_name)})
                           .map(controller => soundCues.appendChild(controller.el))
          
       })

      

</script>
