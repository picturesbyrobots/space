<!DOCTYPE html>
<link rel=stylesheet href=/style.css>
<style>

#cueActor {
  position: fixed;
  padding: 1em 0.5em;
  border-bottom: 1px solid rgba(0, 0, 0, 0.8);
  background: rgba(255, 255, 255, 0.8);
  left: 0;
  right: 0;
  top: 0;
}

#cueActorPlaceholder {
  height: 4em;
}

#cueActor button {
  margin: 0 0.25em;
  font: inherit;
  font-size: 1.5em;
}

</style>
<div id=cueActor><button data-cue="">(clear)</button><button data-cue="standby">Standby</button><button data-cue="go">GO!</button></div>
<div id=cueActorPlaceholder></div>
<ul id="sceneCues"></ul>
<template id=sceneTemplate>
  <li>
    <h1 class=title>title</h1>
    <!--<div class=time>00:00:00</div>-->
    <div class=buttons>
      <button class= sceneButton>Start</button>
    </div>
  </li>
</template>
<script>

const soundPlaybackState = {};

let conn;
const connectWs = () => {
  const ws = new WebSocket(`${location.protocol == 'https:' ? 'wss' : 'ws'}://${location.host}/ws`);

  ws.onclose = e => {
    setTimeout(connectWs, 1000);
  };
  ws.onmessage = e => {
    const message = JSON.parse(e.data);
    const {type, body} = message;
    switch (type) {
      default:
        console.log('message', type, body);
    }
  };
  ws.onopen = e => {
  };

  conn = {
    send(type, body) {
      ws.send(JSON.stringify({ type, body }));
    }
  };
};

connectWs();

class SceneController{
  constructor(scene) {
    this.scene = scene;
    this.el = sceneTemplate.content.firstElementChild.cloneNode(true);

    this.sceneButton = this.el.querySelector('.sceneButton');
    this.el.querySelector('.title').textContent = scene;

    this.sceneButton.addEventListener('mousedown', e => {

      conn && conn.send('setKnob', {name: "hmlt_scene", value : scene})

      // this.setNeedsDisplay();
    });

  }
  // setNeedsDisplay() {
  //   if (this.needsDisplay)
  //     return;
  //   this.needsDisplay = true;
  //   requestAnimationFrame(() => this.display());
  // }
  // display() {
  //   if (this.playTime)
  //     this.setNeedsDisplay();
  // }
  send() {
    conn.sendScene(this.scene);
  }
}

class CreditController {

  constructor() {

    this.el = sceneTemplate.content.firstElementChild.cloneNode(true);

    this.sceneButton = this.el.querySelector('.sceneButton');
    this.el.querySelector('.title').textContent = 'Roll Credits';

    this.sceneButton.addEventListener('mousedown', e => {

      conn && conn.send('broadcast', {type: 'hmlt_chat', body:{cmd : 'roll_credits', data : {speed: .1}}})
      // this.setNeedsDisplay();
    });

  }
}

let config = 'hmltConfig.js'
 fetch(`https://hamlet-gl-assets.s3.amazonaws.com/config/${config}`)
        .then(

        response => response.json())
        .then(data => {
          data.map(scene_data => {return new SceneController(scene_data.sceneName)})
                .map(controller => sceneCues.appendChild(controller.el))



        })
let credit_controller = new CreditController()
sceneCues.appendChild(credit_controller.el)

const actorCues = {
  standby: {
    message: 'STAND BY',
    bg: 'rgba(100, 100, 100, 0.5)',
    hold: 10000,
  },
  go: {
    message: 'GO!',
    bg: 'rgba(0, 127, 0, 0.5)',
    hold: 1000,
  },
}

for (const button of document.querySelectorAll('button[data-cue]')) {
  const cue = actorCues[button.dataset.cue];
  button.addEventListener('click', e => {
    conn && conn.send('broadcast', {
        type: 'hmlt_cue',
        body: cue,
      });
  });
}

</script>
